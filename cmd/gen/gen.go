// The following directive is necessary to make the package coherent:

// +build ignore

// This program generates secret.go. It can be invoked by running
// go generate

package main

import (
	"io/ioutil"
	"log"
	"os"
	"text/template"
	"time"
)

func main() {
	const htpasswdFile = ".htpasswd"

	htpasswdData, err := ioutil.ReadFile(htpasswdFile)
	check(err)

	f, err := os.Create("secret.go")
	check(err)
	defer f.Close()

	packageTemplate.Execute(f, struct {
		Timestamp    time.Time
		HtpasswdFile string
		KeyFile      string
		HtpasswdData string
		PrivKeyData  string
	}{
		Timestamp:    time.Now(),
		HtpasswdFile: htpasswdFile,
		HtpasswdData: addBackTicks(string(htpasswdData)),
	})
}

// Helper functions
func addBackTicks(input string) string {
	return "`" + input + "`"
}

func check(err error) {
	if err != nil {
		log.Fatal(err)
	}
}

var packageTemplate = template.Must(template.New("").Parse(`// Code generated by go generate; DO NOT EDIT.
// This file was generated by robots at
// {{ .Timestamp }}
// using data from
// {{ .HtpasswdFile }}
// {{ .KeyFile }}

package main

var htpasswdData = {{ .HtpasswdData }}
`))
